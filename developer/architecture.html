<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Architecture and Execution Flow &mdash; CMakeTest 1.0.0alpha documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=d4e7da7a"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Bootstrap Templates" href="templates.html" />
    <link rel="prev" title="Developer Documentation" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            CMakeTest
          </a>
              <div class="version">
                1.0.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../about.html">About CMakeTest</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faqs.html">Frequently Asked Questions (FAQs)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../writing_tests/index.html">Writing Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Developer Documentation</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="index.html#system-design">System Design</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Architecture and Execution Flow</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#execution-stages">Execution Stages</a></li>
<li class="toctree-l4"><a class="reference internal" href="#test-discovery">Test Discovery</a></li>
<li class="toctree-l4"><a class="reference internal" href="#test-execution">Test Execution</a></li>
<li class="toctree-l4"><a class="reference internal" href="#error-catching-and-recovery">Error Catching and Recovery</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="templates.html">Bootstrap Templates</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#cmake-reference">CMake Reference</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">CMakeTest</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Developer Documentation</a></li>
      <li class="breadcrumb-item active">Architecture and Execution Flow</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/developer/architecture.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="architecture-and-execution-flow">
<h1>Architecture and Execution Flow<a class="headerlink" href="#architecture-and-execution-flow" title="Link to this heading"></a></h1>
<p>CMakeTest is built around the concept of an <code class="docutils literal notranslate"><span class="pre">Execution</span> <span class="pre">Unit</span></code>.
A unit is an object representing a test or test section
and may contain other subunits that represent subsections.
An execution unit contains all of the information needed
to run the test including the containing file,
the test ID, and whether its <code class="code docutils literal notranslate"><span class="pre">EXPECTFAIL</span></code> option is set.
The object system is provided by <code class="docutils literal notranslate"><span class="pre">CMakePP</span></code> and the class
that represents execution units is
<a class="reference internal" href="cmake_test/execution_unit.html#cmake_test-execution_unit.CTExecutionUnit" title="cmake_test/execution_unit.CTExecutionUnit"><code class="xref py py-obj docutils literal notranslate"><span class="pre">CTExecutionUnit</span></code></a>.</p>
<section id="execution-stages">
<h2>Execution Stages<a class="headerlink" href="#execution-stages" title="Link to this heading"></a></h2>
<p>CMakeTest runs in two stages: the configure stage and the test stage.
The test stage is executed by a <code class="code docutils literal notranslate"><span class="pre">ctest</span></code> command in the directory
that tests are built in.</p>
<section id="configure-stage">
<h3>Configure Stage<a class="headerlink" href="#configure-stage" title="Link to this heading"></a></h3>
<p>During the configure stage, CMakeTest scans directories that were added via
<a class="reference internal" href="cmake_test/add_dir.html#cmake_test-add_dir.ct_add_dir" title="cmake_test/add_dir.ct_add_dir"><code class="xref py py-obj docutils literal notranslate"><span class="pre">ct_add_dir</span></code></a> and generates a bootstrap CTest test file
for each CMake file in each directory. The bootstrap file is generated from a
template, which is explained in <a class="reference internal" href="templates.html#bootstrap-templates"><span class="std std-ref">Bootstrap Templates</span></a>.</p>
</section>
<section id="test-stage">
<h3>Test Stage<a class="headerlink" href="#test-stage" title="Link to this heading"></a></h3>
<p>The test stage is the phase in which the majority of CMakeTest
code is executed. The generated bootstrap files handle the setup of the CMakeTest
runtime. From there the bootstrap sequence begins the test discovery and execution
procedure.</p>
</section>
</section>
<section id="test-discovery">
<h2>Test Discovery<a class="headerlink" href="#test-discovery" title="Link to this heading"></a></h2>
<p>Tests are discovered by <code class="code docutils literal notranslate"><span class="pre">include()</span></code>-ing the file under test,
which will execute all top-level <a class="reference internal" href="cmake_test/add_test.html#cmake_test-add_test.ct_add_test" title="cmake_test/add_test.ct_add_test"><code class="xref py py-obj docutils literal notranslate"><span class="pre">ct_add_test</span></code></a> calls.
These calls instantiate one <a class="reference internal" href="cmake_test/execution_unit.html#cmake_test-execution_unit.CTExecutionUnit" title="cmake_test/execution_unit.CTExecutionUnit"><code class="xref py py-obj docutils literal notranslate"><span class="pre">CTExecutionUnit</span></code></a>
object each and add it to a <code class="code docutils literal notranslate"><span class="pre">CMAKETEST_TEST_INSTANCES</span></code> CMakePP global list.
This initial discovery procedure does not discover subsections of tests.</p>
</section>
<section id="test-execution">
<h2>Test Execution<a class="headerlink" href="#test-execution" title="Link to this heading"></a></h2>
<p>Once all tests are discovered, they are then executed via
<a class="reference internal" href="cmake_test/exec_tests.html#cmake_test-exec_tests.ct_exec_tests" title="cmake_test/exec_tests.ct_exec_tests"><code class="xref py py-obj docutils literal notranslate"><span class="pre">ct_exec_tests</span></code></a>. This function first
registers the global exception handler using
<a class="reference internal" href="cmake_test/register_exception_handler.html#cmake_test-register_exception_handler.ct_register_exception_handler" title="cmake_test/register_exception_handler.ct_register_exception_handler"><code class="xref py py-obj docutils literal notranslate"><span class="pre">ct_register_exception_handler</span></code></a>
and then loops over the execution
units stored in <code class="code docutils literal notranslate"><span class="pre">CMAKETEST_TEST_INSTANCES</span></code>, calling the associated
<a class="reference internal" href="cmake_test/execution_unit.html#cmake_test-execution_unit.CTExecutionUnit.execute" title="cmake_test/execution_unit.CTExecutionUnit.execute"><code class="xref py py-obj docutils literal notranslate"><span class="pre">execute</span></code></a> method.</p>
<p>The <code class="code docutils literal notranslate"><span class="pre">execute()</span></code> method is the meat of the test execution.
It begins by setting some needed globals, and then checks if the
test is <code class="code docutils literal notranslate"><span class="pre">EXPECTFAIL</span></code>. If so, the test is executed via
<a class="reference internal" href="cmake_test/expectfail_subprocess.html#cmake_test-expectfail_subprocess.ct_expectfail_subprocess" title="cmake_test/expectfail_subprocess.ct_expectfail_subprocess"><code class="xref py py-obj docutils literal notranslate"><span class="pre">ct_expectfail_subprocess</span></code></a>.
Otherwise, the test is executed via calling the function
directly using CMakePP’s <code class="code docutils literal notranslate"><span class="pre">cpp_call_fxn()</span></code> command.</p>
<p>During the test execution, subsections are discovered
but not executed. The discovery happens in a similar vein as
the test discovery, i.e. <a class="reference internal" href="cmake_test/add_section.html#cmake_test-add_section.ct_add_section" title="cmake_test/add_section.ct_add_section"><code class="xref py py-obj docutils literal notranslate"><span class="pre">ct_add_section</span></code></a>
instantiates a new execution unit and adds it to the currently-executing
unit’s <a class="reference internal" href="cmake_test/execution_unit.html#cmake_test-execution_unit.CTExecutionUnit.children" title="cmake_test/execution_unit.CTExecutionUnit.children"><code class="xref py py-obj docutils literal notranslate"><span class="pre">children</span></code></a> map.</p>
<p>Once the test has finished executing, a pass line is printed if no errors were
detected. The test’s subsections are then executed via the unit’s
<a class="reference internal" href="cmake_test/execution_unit.html#cmake_test-execution_unit.CTExecutionUnit.exec_sections" title="cmake_test/execution_unit.CTExecutionUnit.exec_sections"><code class="xref py py-obj docutils literal notranslate"><span class="pre">exec_sections</span></code></a> method.</p>
</section>
<section id="error-catching-and-recovery">
<h2>Error Catching and Recovery<a class="headerlink" href="#error-catching-and-recovery" title="Link to this heading"></a></h2>
<p>CMake does not have any concept of error recovery,
any <code class="code docutils literal notranslate"><span class="pre">message(FATAL_ERROR</span> <span class="pre">...)</span></code> call will immediately terminate
the interpreter. CMakeTest must be able to catch these errors,
log the error and label the test as failing, and continue executing tests.
Additionally, CMakePP includes a form of exceptions that also need to be
caught before they result in interpreter termination. The biggest problem
with these exceptions is that they cannot unwind the stack, so once the exception
handler returns the execution continues unabated from the throw point.</p>
<p>CMakeTest handles these problems using a few somewhat-“hacky” tricks.
The first of these tricks overrides the builtin <code class="code docutils literal notranslate"><span class="pre">message()</span></code> function
with a custom one (<a class="reference internal" href="cmake_test/overrides.html#cmake_test-overrides.message" title="cmake_test/overrides.message"><code class="xref py py-obj docutils literal notranslate"><span class="pre">cmake_test/overrides.message</span></code></a>). This override
converts all <code class="code docutils literal notranslate"><span class="pre">FATAL_ERROR</span></code> messages to CMakePP exceptions. This allows
all vanilla CMake code running under tests to error without immediately terminating
the interpreter, including code in external modules.</p>
<p>The second trick exists in the exception handler registered by
<a class="reference internal" href="cmake_test/register_exception_handler.html#cmake_test-register_exception_handler.ct_register_exception_handler" title="cmake_test/register_exception_handler.ct_register_exception_handler"><code class="xref py py-obj docutils literal notranslate"><span class="pre">ct_register_exception_handler</span></code></a>.
The handler is registered for all exceptions, which means it also handles
the generic exceptions generated by our <code class="code docutils literal notranslate"><span class="pre">message()</span></code> override.
When the handler catches an exception it checks the execution unit that
is currently running (tracked by a global), sets the
<a class="reference internal" href="cmake_test/execution_unit.html#cmake_test-execution_unit.CTExecutionUnit.has_printed" title="cmake_test/execution_unit.CTExecutionUnit.has_printed"><code class="xref py py-obj docutils literal notranslate"><span class="pre">has_printed</span></code></a> and
<a class="reference internal" href="cmake_test/execution_unit.html#cmake_test-execution_unit.CTExecutionUnit.has_executed" title="cmake_test/execution_unit.CTExecutionUnit.has_executed"><code class="xref py py-obj docutils literal notranslate"><span class="pre">has_executed</span></code></a>
attributes to true, and then calls
<a class="reference internal" href="cmake_test/exec_tests.html#cmake_test-exec_tests.ct_exec_tests" title="cmake_test/exec_tests.ct_exec_tests"><code class="xref py py-obj docutils literal notranslate"><span class="pre">ct_exec_tests</span></code></a> again.</p>
<p>This may seem counter-intuitive, but by restarting the execution
and by checking the previously-set variables we can selectively
skip tests that have already ran and only run those that have not ran.
This works around the inability to unwind the stack. Once the
<code class="code docutils literal notranslate"><span class="pre">ct_exec_tests()</span></code> call returns we call
<a class="reference internal" href="cmake_test/overrides.html#cmake_test-overrides.ct_exit" title="cmake_test/overrides.ct_exit"><code class="xref py py-obj docutils literal notranslate"><span class="pre">ct_exit</span></code></a> to terminate the interpreter,
which prevents the code up the stack from continuing.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="Developer Documentation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="templates.html" class="btn btn-neutral float-right" title="Bootstrap Templates" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, CMakePP Organization.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>